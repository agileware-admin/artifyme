// ArtifyMe Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_HOST")
}

// ===========================================
// User Model
// ===========================================
model User {
  id          String  @id @default(uuid())
  keycloakId  String  @unique
  email       String  @unique
  name        String?
  credits     Int     @default(0)
  preferences Json?

  // Relations
  transformations           Transformation[]
  orders                    Order[]
  subscription              Subscription?
  passwordResetTokens       PasswordResetToken[]
  accountReactivationTokens AccountReactivationToken[]

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([keycloakId])
  @@index([deletedAt])
}

// ===========================================
// Subscription Model
// ===========================================
model Subscription {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan         String // basic, pro, premium
  status       String @default("active") // active, inactive, cancelled
  billingCycle String // monthly, yearly

  // Payment provider info
  stripeSubscriptionId String?
  stripeCustomerId     String?
  asaasSubscriptionId  String?
  asaasCustomerId      String?

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([stripeSubscriptionId])
  @@index([asaasSubscriptionId])
}

// ===========================================
// Transformation Model
// ===========================================
model Transformation {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  style  String
  status String @default("pending") // pending, processing, completed, failed

  inputImageUrl  String?
  inputImageData String? @db.Text // Base64 for temporary storage
  outputImageUrl String?

  errorMessage   String?
  processingTime Int? // in milliseconds

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@index([style])
  @@index([createdAt])
}

// ===========================================
// Order Model
// ===========================================
model Order {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   String // credits, subscription, product
  status String @default("pending") // pending, completed, failed, refunded

  amount   Int // in cents
  currency String @default("EUR")

  // Payment info
  paymentProvider String? // stripe, asaas
  paymentId       String?

  metadata Json? // Additional order data (credits amount, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([paymentId])
  @@index([createdAt])
}

// ===========================================
// Lead Model (for marketing)
// ===========================================
model Lead {
  id          String  @id @default(uuid())
  name        String
  email       String  @unique
  phone       String?
  countryCode String?

  source     String? // landing_page, popup, etc.
  couponUsed String?

  convertedAt DateTime?

  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

// ===========================================
// Coupon Model
// ===========================================
model Coupon {
  id          String  @id @default(uuid())
  code        String  @unique
  description String?

  discountType  String // percentage, fixed
  discountValue Int // percentage (10 = 10%) or fixed amount in cents

  maxUses   Int?
  usedCount Int  @default(0)

  validFrom  DateTime  @default(now())
  validUntil DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())

  @@index([code])
  @@index([isActive])
}

model PasswordResetToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String    @db.Text
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model AccountReactivationToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String    @db.Text
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}
